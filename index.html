<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¸­è¯é…æ–¹ï¼ˆä¼˜åŒ–ç‰ˆï¼‰</title>
  <style>
    :root{--bg:#f6f8fb;--card:#ffffff;--muted:#6b7280;--accent:#7c3aed;--radius:12px}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:#f8fafc}
    .app{padding:14px;max-width:540px;margin:auto}

    header{margin-bottom:10px}
    h1{font-size:18px;margin:0 0 4px 0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    /* ä¸¤è¡Œå¸¦å›¾æ ‡æ ‡ç­¾ */
    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .tab{background:var(--card);padding:6px 10px 6px 8px;border-radius:20px;font-size:13px;border:1px solid transparent;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.06);display:flex;align-items:center;gap:8px;min-height:40px}
    .tab .icon{font-size:18px;line-height:1;flex-shrink:0}
    .tab span{display:inline-block;max-width:120px;text-overflow:ellipsis;white-space:nowrap;overflow:hidden}
    .tab.active{border-color:var(--accent);color:var(--accent);font-weight:600}

    /* ä¸»å†…å®¹å¡ç‰‡ */
    .card-main{background:var(--card);border-radius:var(--radius);padding:14px;margin-top:10px;box-shadow:0 8px 20px rgba(0,0,0,0.06)}
    .hero{display:flex;gap:12px;align-items:flex-start}
    .hero .pic{width:140px;height:140px;border-radius:10px;overflow:hidden;background:#eee;flex-shrink:0;position:relative}
    .hero img{width:100%;height:100%;object-fit:cover;display:block;transition:opacity 0.25s ease}
    .hero img.loading{opacity:0.5}
    h2{margin:0;font-size:17px}
    .meta{font-size:13px;color:var(--muted);margin-top:4px}

    .section{margin-top:12px}
    .label{font-size:13px;color:var(--muted);margin-bottom:6px}
    .box{background:#fdfefe;padding:10px;border-radius:10px;font-size:14px;border:1px solid rgba(0,0,0,0.04)}

    /* åœºæ™¯å¤§å›¾æ ·å¼ï¼šæ¯å¼ ç‹¬å ä¸€è¡Œï¼Œå°ºå¯¸æ›´å¤§ */
    .scene-img{width:100%;height:180px;object-fit:cover;border-radius:8px;background:#f3f4f6;display:block;transition:opacity 0.25s ease}
    .scene-img.loading{opacity:0.5}
    .scene-text{margin-top:8px;color:var(--muted);font-size:14px}

    footer{margin-top:14px;display:flex;gap:10px}
    .btn{flex:1;padding:10px;border:0;border-radius:10px;font-weight:600;background:var(--accent);color:#fff}

    /* åŠ è½½åŠ¨ç”» */
    .loading-shimmer {position: absolute;top: 0;left: 0;width: 100%;height: 100%;background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0) 100%);background-size: 200% 100%;animation: shimmer 1.5s infinite;border-radius: inherit}
    @keyframes shimmer {0% { background-position: -200% 0; }100% { background-position: 200% 0; }}
    @media (max-width:420px){.tab span{max-width:90px}.hero .pic{width:110px;height:110px}.scene-img{height:120px}}
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>ä¸­è¯é…æ–¹é€ŸæŸ¥ï¼ˆä¼˜åŒ–ç‰ˆï¼‰</h1>
    <p class="lead">æ”¹è¿›ç‚¹ï¼šå¹¶å‘å—æ§é¢„åŠ è½½ã€fetch+createImageBitmapè§£ç ã€ä¼˜å…ˆæ˜¾ç¤ºå·²è§£ç å›¾ç‰‡ã€å‡å°‘ä¸»çº¿ç¨‹é˜»å¡ã€‚</p>
  </header>

  <!-- ä¸¤è¡Œå›¾æ ‡æ ‡ç­¾æ  -->
  <div class="tabs" id="tabs" aria-label="é…æ–¹åˆ†ç±»"></div>

  <div class="card-main" role="region" aria-live="polite">
    <div class="hero">
      <div class="pic" id="detail-pic">
        <img src="" alt="äº§å“å›¾å ä½" decoding="async">
        <div class="loading-shimmer" style="display:none" id="main-loading"></div>
      </div>
      <div style="flex:1">
        <h2 id="detail-title">è¯·é€‰æ‹©é¡¹ç›®</h2>
        <div class="meta" id="detail-sub">é€‰æ‹©ä¸Šæ–¹ä»»ä¸€æ ‡ç­¾æŸ¥çœ‹è¯¦æƒ…</div>
      </div>
    </div>

    <div class="section">
      <div class="label">é…æ–¹</div>
      <div class="box" id="detail-formula">â€”</div>
    </div>

    <!-- åœºæ™¯ä¸€ï¼ˆç‹¬å ä¸€è¡Œï¼‰ -->
    <div class="section">
      <div class="label">ä½¿ç”¨åœºæ™¯ 1</div>
      <div class="box">
        <img src="" alt="åœºæ™¯1å ä½å›¾" id="detail-scene1" class="scene-img" decoding="async">
        <div id="detail-scene1-text" class="scene-text">â€”</div>
      </div>
    </div>

    <!-- åœºæ™¯äºŒï¼ˆç‹¬å ä¸€è¡Œï¼‰ -->
    <div class="section">
      <div class="label">ä½¿ç”¨åœºæ™¯ 2</div>
      <div class="box">
        <img src="" alt="åœºæ™¯2å ä½å›¾" id="detail-scene2" class="scene-img" decoding="async">
        <div id="detail-scene2-text" class="scene-text">â€”</div>
      </div>
    </div>

    <footer>
      <button class="btn" id="btn-copy">å¤åˆ¶é…æ–¹</button>
    </footer>
  </div>
</div>

<script>
/* ------------------ æ•°æ®ä¸åŸºç¡€å·¥å…· ------------------ */
const ITEMS = [
  {id:'insomnia', title:'å¤±çœ /å‹åŠ›å¤§', icon:'ğŸŒ™', sub:'å®‰ç¥åŠ©çœ æ¬¾', scene1Text:'é…’åº—å®¢æˆ¿é¤', scene2Text:'æ·±å¤œä¾¿åˆ©åº—', formula:'é¢ç²‰+é…¸æ£ä»+èŒ¯è‹“+è¿œå¿—'},
  {id:'children', title:'å„¿ç«¥/ç§¯é£Ÿäººç¾¤', icon:'ğŸ§’', sub:'å¥è„¾æ¶ˆç§¯æ¬¾', scene1Text:'äº²å­é¤å…', scene2Text:'å¹¼å„¿å›­é…é¤', formula:'é¢ç²‰+é¸¡å†…é‡‘+éº¦èŠ½+å±±æ¥‚'},
  {id:'cold', title:'ç•å¯’/ä½æ¸©', icon:'â„ï¸', sub:'å¾¡å¯’æš–èº«æ¬¾', scene1Text:'ç«é”…åº—é™„é¤', scene2Text:'ç¤¾åŒºæ—©é¤è½¦', formula:'é¢ç²‰+ç”Ÿå§œ+çº¢ç³–+è‚‰'},
  {id:'anxiety', title:'ç„¦è™‘/è‚æ°”éƒç»“', icon:'ğŸ§­', sub:'ç–è‚ç†æ°”æ¬¾', scene1Text:'èŒåœºè½»é£Ÿåº—', scene2Text:'å¿ƒç†å’¨è¯¢å®¤é…å¥—é¤', formula:'é¢ç²‰+ä½›æ‰‹+é¦™æ©¼+é™ˆçš®'},
  {id:'fatigue', title:'ç†¬å¤œè‚¾è™š/ç²¾åŠ›ä¸è¶³', icon:'âš¡', sub:'ç›Šè‚¾å›ºç²¾æ¬¾', scene1Text:'ç”·å£«å…»ç”Ÿä¼šæ‰€', scene2Text:'ç”µç«é…’åº—é¤é£Ÿ', formula:'é¢ç²‰+èŠ¡å®+è²å­+å±±è¯'},
  {id:'throat', title:'ç”¨å—“è¿‡åº¦/å’½å–‰ä¸é€‚', icon:'ğŸ¤', sub:'æ¸…å’½æ¶¦å–‰æ¬¾', scene1Text:'KTVé…å¥—é¤', scene2Text:'æ•™å¸ˆé£Ÿå ‚', formula:'é¢ç²‰+ç½—æ±‰æœ+æ¡”æ¢—+ç™¾åˆ'},
  {id:'water', title:'ä¹…åæ°´è‚¿/ä»£è°¢ç¼“æ…¢', icon:'ğŸ’§', sub:'æ¶ˆè„‚æ’æµŠæ¬¾', scene1Text:'ç‘œä¼½é¦†è½»é£ŸåŒº', scene2Text:'é€šå‹¤ä¾¿åˆ©åº—', formula:'é¢ç²‰+å†³æ˜å­+èŒ¯è‹“+å†¬ç“œ'},
  {id:'stomach', title:'èƒƒå¯’/ç§‹å†¬èƒƒç—›', icon:'ğŸœ', sub:'æ¸©èƒƒæ•£å¯’æ¬¾', scene1Text:'åŒ—æ–¹æ—©é¤æ‘Š', scene2Text:'ç¤¾åŒºä¾¿æ°‘é£Ÿå ‚', formula:'é¢ç²‰+å°èŒ´é¦™+å¹²å§œ+èƒ¡æ¤’'}
];
const IMG_BASE_PATH = './img/';

function getImageUrl(itemIndex, imageType){
  const imageNumber = itemIndex + 1;
  const imageTypeMap = {'product':1,'scene1':2,'scene2':3};
  return `${IMG_BASE_PATH}${imageNumber}_${imageTypeMap[imageType]}.jpg`;
}
function getCacheKey(itemIndex, imageType){ return `${itemIndex}_${imageType}`; }

/* ------------------ å¼ºåŒ–ç¼“å­˜ä¸å¹¶å‘è½½å…¥å™¨ ------------------ */
const imageCache = new Map();
const objectUrlsToRevoke = new Set();

// å¹¶å‘é™åˆ¶
const MAX_CONCURRENCY = 3;
let currentConcurrency = 0;
const queue = [];

function enqueueLoad(fn){
  return new Promise((resolve, reject)=>{
    queue.push({fn,resolve,reject});
    processQueue();
  });
}
function processQueue(){
  if (!queue.length || currentConcurrency >= MAX_CONCURRENCY) return;
  const item = queue.shift();
  currentConcurrency++;
  item.fn().then(res=>{
    currentConcurrency--;
    item.resolve(res);
    processQueue();
  }).catch(err=>{
    currentConcurrency--;
    item.reject(err);
    processQueue();
  });
}

// ä½¿ç”¨ fetch + createImageBitmap æ¥æŠŠè§£ç ç§»å‡ºä¸»çº¿ç¨‹ï¼ˆè‹¥æ”¯æŒï¼‰
async function fetchAndDecodeImage(url, timeoutMs=8000){
  const controller = new AbortController();
  const id = setTimeout(()=> controller.abort(), timeoutMs);
  try{
    const resp = await fetch(url, {signal: controller.signal, cache: 'no-cache'});
    if (!resp.ok) throw new Error('ç½‘ç»œé”™è¯¯ ' + resp.status);
    const blob = await resp.blob();

    // å°è¯•åœ¨å·¥ä½œçº¿ç¨‹é‡Œè§£ç ä½å›¾
    if (typeof createImageBitmap === 'function'){
      try{
        const bitmap = await createImageBitmap(blob);
        clearTimeout(id);
        return {blob, bitmap};
      }catch(e){
        // é€€å›åˆ°ç›´æ¥ç”Ÿæˆ objectURL
        clearTimeout(id);
        return {blob, bitmap: null};
      }
    }else{
      clearTimeout(id);
      return {blob, bitmap:null};
    }
  }catch(err){
    clearTimeout(id);
    throw err;
  }
}

// æ™ºèƒ½åŠ è½½ï¼ˆå¹¶å‘å—æ§ï¼‰
function smartLoadImage(itemIndex, imageType){
  const cacheKey = getCacheKey(itemIndex, imageType);
  if (imageCache.has(cacheKey)){
    return Promise.resolve(imageCache.get(cacheKey));
  }

  const url = getImageUrl(itemIndex, imageType);

  return enqueueLoad(async ()=>{
    try{
      const {blob, bitmap} = await fetchAndDecodeImage(url);
      const objectUrl = URL.createObjectURL(blob);
      objectUrlsToRevoke.add(objectUrl);
      const cacheItem = {src: objectUrl, blob, bitmap, loaded: true, url};
      imageCache.set(cacheKey, cacheItem);
      return cacheItem;
    }catch(err){
      const cacheItem = {src: null, loaded:false, error:true, url};
      imageCache.set(cacheKey, cacheItem);
      throw err;
    }
  });
}

// Try immediate sync display from cache
function displayCachedImage(imgElement, cacheKey, alt){
  if (imageCache.has(cacheKey)){
    const cacheItem = imageCache.get(cacheKey);
    if (cacheItem.loaded && cacheItem.src){
      // ä¼˜å…ˆä½¿ç”¨å·²ç»createObjectURLè¿‡çš„src
      imgElement.src = cacheItem.src;
      imgElement.alt = alt || imgElement.alt;
      imgElement.style.opacity = '0';
      requestAnimationFrame(()=> requestAnimationFrame(()=>{ imgElement.style.opacity='1'; imgElement.style.transition='opacity 0.2s ease'; }));
      return true;
    }
  }
  return false;
}

function makePlaceholder(text, w=900, h=540, bg='%23f3f4f6', fg='%23888'){
  const svg = `<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"${w}\" height=\"${h}\"><rect width=\"100%\" height=\"100%\" fill=\"${bg}\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" font-family=\"Arial,Helvetica,sans-serif\" font-size=\"20\" fill=\"${fg}\">${text}</text></svg>`;
  return 'data:image/svg+xml,' + svg;
}

/* ------------------ UI ä¸é¢„åŠ è½½ç­–ç•¥ ------------------ */
const tabs = document.getElementById('tabs');
const detailPic = document.getElementById('detail-pic').querySelector('img');
const detailTitle = document.getElementById('detail-title');
const detailSub = document.getElementById('detail-sub');
const detailFormula = document.getElementById('detail-formula');
const detailScene1 = document.getElementById('detail-scene1');
const detailScene2 = document.getElementById('detail-scene2');
const detailScene1Text = document.getElementById('detail-scene1-text');
const detailScene2Text = document.getElementById('detail-scene2-text');
const mainLoading = document.getElementById('main-loading');

function showLoading(){ mainLoading.style.display='block'; detailPic.classList.add('loading'); detailScene1.classList.add('loading'); detailScene2.classList.add('loading'); }
function hideLoading(){ mainLoading.style.display='none'; detailPic.classList.remove('loading'); detailScene1.classList.remove('loading'); detailScene2.classList.remove('loading'); }

// é¢„åŠ è½½ä¸€ç»„ç´¢å¼•ï¼ˆå¹¶å‘å—æ§ï¼‰
async function preloadMultipleImages(itemIndices){
  const tasks = [];
  itemIndices.forEach(index=>{
    if (index>=0 && index<ITEMS.length){ ['product','scene1','scene2'].forEach(type=>{
      const key = getCacheKey(index,type);
      if (!imageCache.has(key)) tasks.push(smartLoadImage(index,type).catch(()=>{}));
    }); }
  });
  // å°æ‰¹é‡ç­‰å¾…ä»¥é¿å…å¤§é‡èµ„æºåŒæ—¶å ç”¨
  const batchSize = 6; // fetch å±‚é¢æ¯ä¸ªè¯·æ±‚è¾ƒå°ï¼Œå¯ä»¥ç¨å¾®æ”¾å®½
  for (let i=0;i<tasks.length;i+=batchSize){
    await Promise.allSettled(tasks.slice(i,i+batchSize));
    await new Promise(r=>setTimeout(r,40));
  }
}

function preloadAdjacentImages(currentIndex){
  const indicesToPreload = [];
  for (let i=Math.max(0,currentIndex-2);i<=Math.min(ITEMS.length-1,currentIndex+2);i++){ indicesToPreload.push(i); }
  // å¼‚æ­¥è§¦å‘ï¼Œä¸é˜»å¡UI
  setTimeout(()=>{ preloadMultipleImages(indicesToPreload).catch(()=>{}); }, 80);
}

// åˆ‡æ¢æ¡ç›®ï¼Œå°½é‡ç«‹å³æ˜¾ç¤ºç¼“å­˜å¹¶å¹¶å‘åŠ è½½ç¼ºå¤±å›¾ç‰‡
async function switchToItem(itemIndex){
  const it = ITEMS[itemIndex]; if(!it) return;
  detailTitle.textContent = it.title; detailSub.textContent = it.sub; detailFormula.textContent = it.formula; detailScene1Text.textContent = it.scene1Text || 'â€”'; detailScene2Text.textContent = it.scene2Text || 'â€”';

  const cacheKeys = [
    {key:getCacheKey(itemIndex,'product'), el:detailPic, alt:it.title+' äº§å“å›¾'},
    {key:getCacheKey(itemIndex,'scene1'), el:detailScene1, alt:it.title+' åœºæ™¯1'},
    {key:getCacheKey(itemIndex,'scene2'), el:detailScene2, alt:it.title+' åœºæ™¯2'}
  ];

  let needLoad = false;
  cacheKeys.forEach(({key,el,alt})=>{
    el.alt = alt;
    if (!displayCachedImage(el,key,alt)){
      // ç«‹å³æ˜¾ç¤ºå ä½ï¼Œå¹¶åœ¨åå°åŠ è½½
      needLoad = true;
      el.src = makePlaceholder(alt, 600, 360);
      el.style.opacity = '1';
    }
    // å¯¹ detail å›¾ç‰‡è®¾ä¸ºé«˜ä¼˜å…ˆçº§
    if (el === detailPic){ el.loading = 'eager'; el.decoding='async'; }
  });

  if (needLoad) showLoading();

  // å¯åŠ¨åŠ è½½ï¼ˆå¹¶ç­‰å¾…å¿…è¦çš„ main å›¾ç‰‡ï¼‰
  const loadPromises = cacheKeys.map(({key})=>{
    if (imageCache.has(key)) return Promise.resolve();
    const [indexStr,type] = key.split('_');
    const itemIdx = parseInt(indexStr);
    return smartLoadImage(itemIdx,type).then(cacheItem=>{
      // åŠ è½½å®Œæˆåå¦‚æœ still relevantï¼ˆsrc æœªè¢«æ›¿æ¢ä¸ºåˆ«çš„é¡¹ï¼‰åˆ™å±•ç¤º
      const targetEl = cacheKeys.find(c=>c.key===key).el;
      if (targetEl){
        // æœ€å¥½æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦ä»æ˜¯ itemIndex
        targetEl.src = cacheItem.src || makePlaceholder(cacheItem.url || 'image');
        targetEl.style.opacity='0';
        requestAnimationFrame(()=> requestAnimationFrame(()=>{ targetEl.style.opacity='1'; targetEl.style.transition='opacity 0.18s ease'; }));
      }
    }).catch(()=>{
      const targetEl = cacheKeys.find(c=>c.key===key).el;
      if (targetEl) targetEl.src = makePlaceholder('åŠ è½½å¤±è´¥');
    });
  });

  // ç­‰å¾…é¦–ä¸ªï¼ˆäº§å“å›¾ï¼‰åŠ è½½å®Œæˆæˆ–è¶…æ—¶ä»¥ä¿è¯ä¸»å†…å®¹å¿«é€Ÿå¯è§
  try{
    await Promise.race([
      Promise.all([loadPromises[0]]),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error('ä¸»å›¾åŠ è½½è¶…æ—¶')),1500))
    ]);
  }catch(e){ /* ignoreï¼Œç»§ç»­ç­‰å¾…å…¶ä½™ */ }

  await Promise.allSettled(loadPromises);
  hideLoading();
  preloadAdjacentImages(itemIndex);
}

/* ------------------ æ¸²æŸ“æ ‡ç­¾ä¸äº¤äº’ ------------------ */
function renderTabs(){
  tabs.innerHTML='';
  ITEMS.forEach((it,idx)=>{
    const el = document.createElement('button');
    el.type='button'; el.className='tab' + (idx===0 ? ' active' : ''); el.dataset.index=idx; el.setAttribute('aria-pressed', idx===0 ? 'true' : 'false');
    el.innerHTML = `<span class=\"icon\">${it.icon}</span><span>${it.title}</span>`;

    const preloadHandler = ()=>{ const hoverIndex = parseInt(el.dataset.index); if (!isNaN(hoverIndex)) preloadAdjacentImages(hoverIndex); };
    el.addEventListener('mouseenter', preloadHandler);
    el.addEventListener('touchstart', preloadHandler, {passive:true});

    el.addEventListener('click', async ()=>{
      document.querySelectorAll('.tab').forEach(t=>{ t.classList.remove('active'); t.setAttribute('aria-pressed','false'); });
      el.classList.add('active'); el.setAttribute('aria-pressed','true');
      await switchToItem(idx);
    });

    tabs.appendChild(el);
  });
}

// å¤åˆ¶
document.getElementById('btn-copy').addEventListener('click', ()=>{
  const text = `${detailTitle.textContent}\n${detailSub.textContent}\né…æ–¹ï¼š${detailFormula.textContent}`;
  if (navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(text).then(()=>alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')).catch(()=>fallbackCopy(text)); }
  else fallbackCopy(text);
});
function fallbackCopy(text){ const ta = document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'); }catch(e){ alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶:\n'+text); } ta.remove(); }

/* ------------------ åˆå§‹åŒ– ------------------ */
window.addEventListener('beforeunload', ()=>{ // æ¸…ç† object URLs
  objectUrlsToRevoke.forEach(u=>{ try{ URL.revokeObjectURL(u); }catch(e){} });
});

document.addEventListener('DOMContentLoaded', async ()=>{
  renderTabs();
  // å…ˆå¹¶å‘é¢„åŠ è½½ 0,1,2 çš„ä¸»è¦å›¾ç‰‡
  preloadMultipleImages([0,1,2]).catch(()=>{});
  const firstTab = document.querySelector('.tab');
  if (firstTab) firstTab.click();

  // ç©ºé—²æ—¶é€æ­¥é¢„åŠ è½½å…¨éƒ¨å›¾ç‰‡
  const allIndices = ITEMS.map((_,i)=>i);
  if ('requestIdleCallback' in window){ requestIdleCallback(()=>{ preloadMultipleImages(allIndices).catch(()=>{}); }, {timeout:3000}); }
  else setTimeout(()=>{ preloadMultipleImages(allIndices).catch(()=>{}); }, 3000);
});
</script>
</body>
</html>